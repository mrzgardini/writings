Passare formule all'indicizzatore iloc di pandas e vederlo miracolosamente funzionare alla prima son soddisfazioni.
La forte annidazione dei controlli logici non Ã¨ una best practice ma io sono chimicazza e faccio quello che mi pare.
<pre>
history['buy'] = 0
history['sell'] = 0

for i in range(len(history)):
    if history["sma1"].iloc[i] > history["sma2"].iloc[i]:
        x = i - 1
        if history["sma1"].iloc[x] <= history["sma2"].iloc[x]:
            history.loc[i, "buy"] = 'BUY'
    if history["sma1"].iloc[i] <= history["sma2"].iloc[i]:
        x = i - 1
        if history["sma1"].iloc[x] > history["sma2"].iloc[x]:
            history.loc[i, "sell"] = 'SELL'
</pre>
Funziona!
<pre>
1.70909E+12	0.09613	0.09613	0.09603	0.0961	680892.0	0.095994	0.09597700000000000	BUY	0
1.70909E+12	0.09611	0.09654	0.09609	0.09635	8326975.0	0.09609200000000000	0.09600000000000000	0	0
1.70909E+12	0.09635	0.0964	0.09632	0.09638	252451.0	0.096192	0.09601	0	0
1.70909E+12	0.09636	0.09653	0.09635	0.0964	2427773.0	0.096274	0.0960250000000000	0	0
1.70909E+12	0.09641	0.09645	0.09637	0.09642	383738.0	0.09633	0.0960450000000000	0	0
1.70909E+12	0.09642	0.09642	0.09629	0.09631	847150.0	0.09637200000000000	0.0960600000000000	0	0
1.70909E+12	0.09631	0.09638	0.09626	0.09638	1329831.0	0.09637800000000000	0.09607400000000000	0	0
1.70909E+12	0.09639	0.09643	0.09632	0.09637	691686.0	0.096376	0.09608800000000000	0	0
1.70909E+12	0.09637	0.0964	0.09631	0.09636	425947.0	0.09636800000000000	0.09610300000000000	0	0
1.70909E+12	0.09635	0.09635	0.09622	0.09622	1004509.0	0.096328	0.09611500000000000	0	0
1.70909E+12	0.09621	0.09622	0.09617	0.09622	553464.0	0.09631000000000000	0.09612600000000000	0	0
1.70909E+12	0.09621	0.09625	0.09618	0.09625	702173.0	0.09628400000000000	0.09614800000000000	0	0
1.70909E+12	0.09624	0.09646	0.09616	0.09634	4870331.0	0.096278	0.09616900000000000	0	0
1.70909E+12	0.09634	0.09634	0.09627	0.09632	472933.0	0.09627	0.09618000000000000	0	0
1.70909E+12	0.09632	0.09633	0.09619	0.09625	1058997.0	0.096276	0.09619700000000000	0	0
1.70909E+12	0.09624	0.09633	0.09621	0.09622	711316.0	0.096276	0.09621700000000000	0	0
1.70909E+12	0.09622	0.09627	0.09618	0.09623	947850.0	0.096272	0.09623800000000000	0	0
1.70909E+12	0.09625	0.09625	0.09609	0.0961	771672.0	0.096224	0.09624900000000000	0	SELL
</pre>
